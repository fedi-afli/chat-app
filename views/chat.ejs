<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeğŸ â¤ï¸ | Chat Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-200 h-screen flex flex-col">

    <header class="bg-indigo-600 text-white p-4 flex justify-between items-center shadow-md">
        <h1 class="text-xl font-bold">HomeğŸ â¤ï¸ğŸ’¬</h1>
        <div>
            <span class="mr-4">Logged in as: <strong><%= user.username %></strong></span>
            <a href="/logout" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600 text-sm">Logout</a>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 bg-white p-4 hidden md:block border-r overflow-y-auto">
            <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">ğŸ‘¥ Active Users</h3>
            <p class="text-xs text-gray-400 mb-2">(Click your name to change nickname)</p>
            <ul id="usersList" class="space-y-2 text-gray-600">
                </ul>
        </aside>

        <main class="flex-1 flex flex-col">
            <div id="chat-messages" class="flex-1 p-6 overflow-y-auto space-y-4">
                </div>

<div class="bg-white p-4 border-t flex items-center">
    <form id="chat-form" class="flex w-full gap-2 items-center">
        
        <input type="file" id="imageInput" accept="image/*" class="hidden">
        
        <button type="button" onclick="document.getElementById('imageInput').click()" 
            class="text-gray-500 hover:text-indigo-600 p-2 transition">
            ğŸ“·
        </button>

        <input 
            id="msg" 
            type="text" 
            autocomplete="off" 
            placeholder="Type a message..." 
            class="flex-1 border p-3 rounded-full focus:outline-none focus:border-indigo-500 bg-gray-50"
            required
        />
        <button class="bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition">Send</button>
    </form>
</div>
        </main>
    </div>

<script>
    const socket = io();
    const chatForm = document.getElementById('chat-form');
    const chatMessages = document.getElementById('chat-messages');
    const userList = document.getElementById('usersList');
    const imageInput = document.getElementById('imageInput');

    // ğŸ‘‡ EVENT: When a user selects a file
    imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Convert image to Base64 string
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
            const base64Image = reader.result;
            
            // Emit to server
            socket.emit('chatMessage', { type: 'image', content: base64Image });
        };
        
        // Reset input so you can send the same image again if you want
        imageInput.value = ''; 
    });

    // ... (Keep existing chatForm submit listener) ...
    // BUT: Update the submit listener to send text as an object too
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = e.target.elements.msg.value;
        
        // ğŸ‘‡ Send as object now
        socket.emit('chatMessage', { type: 'text', content: msg });
        
        e.target.elements.msg.value = '';
        e.target.elements.msg.focus();
    });
    
    // ğŸ‘‡ Use 'user.username' and handle 'user.nickname' safely
    const currentUsername = "<%= user.username %>";
    let currentNickname = "<%= user.nickname || user.username %>"; 

    // Join Room
    socket.emit('joinRoom', { 
        username: currentUsername, 
        nickname: currentNickname 
    });

    // 1. Load History
    socket.on('loadMessages', (history) => {
        history.forEach(msg => {
            outputMessage(msg);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // 2. Handle Active Users List
    socket.on('roomUsers', ({ users }) => {
        outputUsers(users);
    });

    // 3. Handle Seen Status
    socket.on('messagesSeen', ({ username }) => {
        if (username === currentUsername) return;
        const seenLabels = document.querySelectorAll('.seen-status');
        seenLabels.forEach(label => {
            if (label.dataset.sender === currentUsername) {
                label.innerText = 'Seen';
                label.style.display = 'block';
            }
        });
    });

    socket.on('messageReadUpdate', ({ messageId, username }) => {
        const messageDiv = document.getElementById(`msg-${messageId}`);
        if (messageDiv) {
            const seenLabel = messageDiv.querySelector('.seen-status');
            if (seenLabel && seenLabel.dataset.sender === currentUsername && username !== currentUsername) {
                seenLabel.innerText = 'Seen';
                seenLabel.style.display = 'block';
            }
        }
    });

    // 4. Receive Message
    socket.on('message', (message) => {
        outputMessage(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Mark as read immediately if chat is open and it's not me
        if (message.type === 'chat' && message.username !== currentUsername) {
            socket.emit('markRead', { messageId: message._id });
        }
    });

    // 5. NICKNAME UPDATE LISTENER
    socket.on('nicknameUpdated', (newNick) => {
        currentNickname = newNick; // Update local variable
    });

    // Send Message
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = e.target.elements.msg.value;
        socket.emit('chatMessage', msg);
        e.target.elements.msg.value = '';
        e.target.elements.msg.focus();
    });

    // ğŸ‘‡ UPDATED: Accepts a target name and allows changing ANYONE
    function requestNicknameChange(targetName) {
        const newNick = prompt(`Change ${targetName}'s name to:`);
        if (newNick && newNick.trim() !== "") {
            // Emits the unrestricted event we created in server.js
            socket.emit('forceChangeNickname', { 
                targetName: targetName, 
                newNick: newNick.trim() 
            });
        }
    }

    // Output Message to DOM
  // Output Message to DOM
    function outputMessage(message) {
        const div = document.createElement('div');
        if (message._id) div.id = `msg-${message._id}`; 

        if (message.type === 'system') {
            div.classList.add('flex', 'justify-center', 'my-2');
            div.innerHTML = `<span class="bg-gray-300 text-gray-700 text-xs px-3 py-1 rounded-full">${message.text}</span>`;
        } else {
            const isMyMessage = message.username === currentUsername;
            
            const seenList = message.seenBy || [];
            const isSeen = seenList.some(u => u !== currentUsername);

            // 1. Check if it is an image (Check both 'messageType' from DB and 'type' from live)
            const isImage = message.messageType === 'image' || message.type === 'image';

            div.classList.add('flex', 'flex-col', isMyMessage ? 'items-end' : 'items-start');
            
            // 2. Create the content HTML based on type
            let contentHtml = '';
            if (isImage) {
                
                // Render Image
                contentHtml = `<img src="${message.text}" class="max-w-[200px] rounded-lg cursor-pointer" onclick="window.open(this.src)" />`;
            } else {
                // Render Text
                contentHtml = `<p>${message.text}</p>`;
            }

            div.innerHTML = `
                <span class="text-xs text-gray-500 mb-1 ${isMyMessage ? 'mr-1' : 'ml-1'}">
                    ${message.nickname || message.username} 
                </span>
                <div class="max-w-md px-4 py-2 rounded-lg shadow-sm ${isMyMessage ? 'bg-blue-500 text-white rounded-br-none' : 'bg-green-500 text-white rounded-bl-none'}">
                    ${contentHtml} 
                </div>
                ${isMyMessage ? 
                    `<span class="text-[10px] text-gray-400 mt-1 seen-status" 
                           data-sender="${message.username}" 
                           style="${isSeen ? 'display:block' : 'display:none'}">
                       Seen
                    </span>` 
                : ''}
            `;
        }
        chatMessages.appendChild(div);
    }

    // ğŸ‘‡ UPDATED: Added onclick event to BOTH (You) and Others
    function outputUsers(users) {
        userList.innerHTML = users.map(userNick => {
            if (userNick === currentNickname) {
                // YOUR NAME (Clickable)
                return `
                    <li onclick="requestNicknameChange('${userNick}')" 
                        class="flex items-center gap-2 p-2 rounded cursor-pointer bg-blue-50 hover:bg-blue-100 transition border border-blue-200"
                        title="Click to change nickname">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span> 
                        <span class="font-bold text-blue-800">${userNick} (You)</span>
                        <span class="text-xs text-blue-400">âœï¸</span>
                    </li>`;
            } else {
                // OTHERS (Now Clickable too!)
                return `
                    <li onclick="requestNicknameChange('${userNick}')"
                        class="flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-gray-100 transition"
                        title="Click to rename this user">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span> 
                        <span>${userNick}</span>
                        <span class="text-xs text-gray-400">âœï¸</span>
                    </li>`;
            }
        }).join('');
    }
</script>
</body>
</html>